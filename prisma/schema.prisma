generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id                  Int                         @id @default(autoincrement())
  createdAt           DateTime                    @default(now())
  clinicId            Int? // Multi-clinic support
  clinic              Clinic?                     @relation(fields: [clinicId], references: [id])
  firstName           String
  lastName            String
  dob                 String
  gender              String
  phone               String
  email               String
  address1            String
  city                String
  state               String
  zip                 String
  lifefileId          String?
  notes               String?
  tags                Json?
  address2            String?
  patientId           String?                     @unique
  stripeCustomerId    String?                     @unique
  source              String                      @default("manual") // "webhook", "api", "manual", "referral", "import"
  sourceMetadata      Json? // Additional source details (e.g., webhook URL, referrer ID, import batch)
  aiConversations     AIConversation[]
  invoices            Invoice[]
  orders              Order[]
  auditEntries        PatientAudit[]
  documents           PatientDocument[]
  payments            Payment[]
  paymentMethods      PaymentMethod[]
  soapNotes           SOAPNote[]
  subscriptions       Subscription[]
  referrals           ReferralTracking[]
  user                User?
  intakeSubmissions   IntakeFormSubmission[]
  weightLogs          PatientWeightLog[]
  medicationReminders PatientMedicationReminder[]
  waterLogs           PatientWaterLog[]
  exerciseLogs        PatientExerciseLog[]
  sleepLogs           PatientSleepLog[]
  nutritionLogs       PatientNutritionLog[]
  tickets             Ticket[]
  appointments        Appointment[]
  superbills          Superbill[]
  carePlans           CarePlan[]
  smsLogs             SmsLog[]
  discountUsages      DiscountUsage[]
  affiliateReferrals  AffiliateReferral[]
  chatMessages        PatientChatMessage[]

  @@unique([clinicId, patientId])
  @@index([clinicId])
}

model Order {
  id                 Int          @id @default(autoincrement())
  createdAt          DateTime     @default(now())
  clinicId           Int? // Multi-clinic support
  clinic             Clinic?      @relation(fields: [clinicId], references: [id])
  updatedAt          DateTime     @updatedAt
  messageId          String
  referenceId        String
  lifefileOrderId    String?
  status             String?
  patientId          Int
  providerId         Int
  shippingMethod     Int
  primaryMedName     String?
  primaryMedStrength String?
  primaryMedForm     String?
  errorMessage       String?
  requestJson        String?
  responseJson       String?
  lastWebhookAt      DateTime?
  lastWebhookPayload String?
  shippingStatus     String?
  trackingNumber     String?
  trackingUrl        String?
  provider           Provider     @relation(fields: [providerId], references: [id])
  patient            Patient      @relation(fields: [patientId], references: [id])
  events             OrderEvent[]
  rxs                Rx[]
  tickets            Ticket[]
}

model Rx {
  id            Int    @id @default(autoincrement())
  orderId       Int
  medicationKey String
  medName       String
  strength      String
  form          String
  quantity      String
  refills       String
  sig           String
  order         Order  @relation(fields: [orderId], references: [id])
}

model Provider {
  id                   Int                    @id @default(autoincrement())
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  clinicId             Int? // Multi-clinic support
  clinic               Clinic?                @relation(fields: [clinicId], references: [id])
  firstName            String
  lastName             String
  titleLine            String?
  npi                  String                 @unique
  licenseState         String?
  licenseNumber        String?
  dea                  String?
  email                String?
  phone                String?
  signatureDataUrl     String?
  npiVerifiedAt        DateTime?
  npiRawResponse       Json?
  lastLogin            DateTime?
  user                 User?
  passwordHash         String?
  passwordResetExpires DateTime?
  passwordResetToken   String?
  orders               Order[]
  auditEntries         ProviderAudit[]
  approvedSoapNotes    SOAPNote[]
  intakeFormTemplates  IntakeFormTemplate[]
  appointments         Appointment[]
  availability         ProviderAvailability[]
  timeOff              ProviderTimeOff[]
  superbills           Superbill[]
  carePlans            CarePlan[]
}

model PatientDocument {
  id                 Int                     @id @default(autoincrement())
  createdAt          DateTime                @default(now())
  clinicId           Int? // Multi-clinic support
  clinic             Clinic?                 @relation(fields: [clinicId], references: [id])
  patientId          Int
  filename           String
  mimeType           String
  source             String?
  data               Bytes?                  // PDF binary data (or legacy JSON)
  externalUrl        String?
  sourceSubmissionId String?                 @unique
  category           PatientDocumentCategory @default(OTHER)
  patient            Patient                 @relation(fields: [patientId], references: [id])
  soapNotes          SOAPNote[]
  // Future fields (require DB migration):
  // intakeData         Json?                   // Structured intake form answers
  // pdfGeneratedAt     DateTime?               // When the PDF was generated
  // intakeVersion      String?                 // Track intake form version
}

model PatientCounter {
  id      Int @id @default(autoincrement())
  current Int @default(0)
}

model OrderEvent {
  id              Int      @id @default(autoincrement())
  createdAt       DateTime @default(now())
  orderId         Int
  lifefileOrderId String?
  eventType       String
  payload         Json?
  note            String?
  order           Order    @relation(fields: [orderId], references: [id])
}

model ProviderAudit {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  providerId Int
  actorEmail String?
  action     String
  diff       Json?
  provider   Provider @relation(fields: [providerId], references: [id])
}

model PatientAudit {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  patientId  Int
  actorEmail String?
  action     String
  diff       Json?
  patient    Patient  @relation(fields: [patientId], references: [id])
}

model Invoice {
  id                   Int           @id @default(autoincrement())
  createdAt            DateTime      @default(now())
  clinicId             Int? // Multi-clinic support
  clinic               Clinic?       @relation(fields: [clinicId], references: [id])
  updatedAt            DateTime      @updatedAt
  stripeInvoiceId      String?       @unique // Optional for demo mode
  stripeInvoiceNumber  String?
  stripeInvoiceUrl     String?
  stripePdfUrl         String?
  patientId            Int
  description          String?
  amount               Int?          // Total amount for demo mode
  amountDue            Int?
  amountPaid           Int           @default(0)
  currency             String        @default("usd")
  status               InvoiceStatus @default(DRAFT)
  dueDate              DateTime?
  paidAt               DateTime?
  lineItems            Json?
  metadata             Json?
  orderId              Int?
  commissionGenerated  Boolean       @default(false)
  createSubscription   Boolean       @default(false) // If true, creates subscription on payment
  subscriptionCreated  Boolean       @default(false) // Was subscription created?
  patient              Patient       @relation(fields: [patientId], references: [id])
  commission           Commission?
  payments             Payment[]
  items                InvoiceItem[] // Structured line items
}

model Payment {
  id                    Int           @id @default(autoincrement())
  createdAt             DateTime      @default(now())
  clinicId              Int? // Multi-clinic support
  clinic                Clinic?       @relation(fields: [clinicId], references: [id])
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?
  stripeRefundId        String?       // Stripe refund ID if refunded
  amount                Int
  currency              String        @default("usd")
  status                PaymentStatus @default(PENDING)
  paymentMethod         String?
  failureReason         String?
  refundedAmount        Int?          // Amount refunded in cents
  refundedAt            DateTime?     // When refund was processed
  patientId             Int
  invoiceId             Int?
  subscriptionId        Int?
  description           String?
  notes                 String?
  metadata              Json?
  invoice               Invoice?      @relation(fields: [invoiceId], references: [id])
  patient               Patient       @relation(fields: [patientId], references: [id])
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id])
}

model PaymentMethod {
  id                    Int            @id @default(autoincrement())
  createdAt             DateTime       @default(now())
  clinicId              Int? // Multi-clinic support
  clinic                Clinic?        @relation(fields: [clinicId], references: [id])
  updatedAt             DateTime       @updatedAt
  patientId             Int
  encryptedCardNumber   String
  cardLast4             String
  cardBrand             String?
  expiryMonth           Int
  expiryYear            Int
  cardholderName        String
  encryptedCvv          String?
  billingZip            String
  stripePaymentMethodId String?        @unique
  isDefault             Boolean        @default(false)
  isActive              Boolean        @default(true)
  lastUsedAt            DateTime?
  encryptionKeyId       String
  fingerprint           String?
  patient               Patient        @relation(fields: [patientId], references: [id])
  subscriptions         Subscription[]
}

model SOAPNote {
  id                 Int                @id @default(autoincrement())
  createdAt          DateTime           @default(now())
  clinicId           Int? // Multi-clinic support
  clinic             Clinic?            @relation(fields: [clinicId], references: [id])
  updatedAt          DateTime           @updatedAt
  patientId          Int
  subjective         String
  objective          String
  assessment         String
  plan               String
  sourceType         SOAPSourceType     @default(MANUAL)
  intakeDocumentId   Int?
  generatedByAI      Boolean            @default(false)
  aiModelVersion     String?
  status             SOAPNoteStatus     @default(DRAFT)
  approvedBy         Int?
  approvedAt         DateTime?
  lockedAt           DateTime?
  editPasswordHash   String?
  promptTokens       Int?
  completionTokens   Int?
  estimatedCost      Float?
  medicalNecessity   String?
  approvedByProvider Provider?          @relation(fields: [approvedBy], references: [id])
  intakeDocument     PatientDocument?   @relation(fields: [intakeDocumentId], references: [id])
  patient            Patient            @relation(fields: [patientId], references: [id])
  revisions          SOAPNoteRevision[]

  @@index([patientId, status])
}

model SOAPNoteRevision {
  id              Int      @id @default(autoincrement())
  createdAt       DateTime @default(now())
  soapNoteId      Int
  editorEmail     String?
  editorRole      String?
  previousContent Json
  newContent      Json
  changeReason    String?
  soapNote        SOAPNote @relation(fields: [soapNoteId], references: [id])

  @@index([soapNoteId])
}

model AIConversation {
  id            Int         @id @default(autoincrement())
  createdAt     DateTime    @default(now())
  clinicId      Int? // Multi-clinic support
  clinic        Clinic?     @relation(fields: [clinicId], references: [id])
  updatedAt     DateTime    @updatedAt
  patientId     Int?
  userEmail     String
  sessionId     String
  isActive      Boolean     @default(true)
  lastMessageAt DateTime?
  patient       Patient?    @relation(fields: [patientId], references: [id])
  messages      AIMessage[]

  @@index([sessionId])
  @@index([patientId])
}

model AIMessage {
  id               Int            @id @default(autoincrement())
  createdAt        DateTime       @default(now())
  conversationId   Int
  role             String
  content          String
  queryType        String?
  citations        Json?
  confidence       Float?
  promptTokens     Int?
  completionTokens Int?
  estimatedCost    Float?
  responseTimeMs   Int?
  conversation     AIConversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
}

model Subscription {
  id                   Int                @id @default(autoincrement())
  createdAt            DateTime           @default(now())
  clinicId             Int? // Multi-clinic support
  clinic               Clinic?            @relation(fields: [clinicId], references: [id])
  updatedAt            DateTime           @updatedAt
  patientId            Int
  planId               String
  planName             String
  planDescription      String
  status               SubscriptionStatus @default(ACTIVE)
  amount               Int
  currency             String             @default("usd")
  interval             String             @default("month")
  intervalCount        Int                @default(1)
  startDate            DateTime           @default(now())
  currentPeriodStart   DateTime           @default(now())
  currentPeriodEnd     DateTime           @default(now())
  nextBillingDate      DateTime?
  canceledAt           DateTime?
  pausedAt             DateTime?
  resumeAt             DateTime?
  endedAt              DateTime?
  paymentMethodId      Int?
  stripeSubscriptionId String?            @unique
  metadata             Json?
  lastPaymentId        Int?
  failedAttempts       Int                @default(0)
  patient              Patient            @relation(fields: [patientId], references: [id])
  paymentMethod        PaymentMethod?     @relation(fields: [paymentMethodId], references: [id])
  payments             Payment[]
  actions              SubscriptionAction[]

  @@index([patientId])
  @@index([status])
}

model Influencer {
  id                     Int                     @id @default(autoincrement())
  createdAt              DateTime                @default(now())
  clinicId               Int? // Multi-clinic support
  clinic                 Clinic?                 @relation(fields: [clinicId], references: [id])
  updatedAt              DateTime                @updatedAt
  email                  String                  @unique
  name                   String
  promoCode              String                  @unique
  commissionRate         Float                   @default(0.10) // 10% default commission
  status                 InfluencerStatus        @default(ACTIVE)
  passwordHash           String?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  lastLogin              DateTime?
  phone                  String?
  paypalEmail            String?
  preferredPaymentMethod String?                 @default("paypal")
  notes                  String?
  metadata               Json?
  referrals              ReferralTracking[]
  commissions            Commission[]
  payouts                CommissionPayout[]
  bankAccounts           InfluencerBankAccount[]
  user                   User?
  
  // New affiliate system relations
  discountCodes          DiscountCode[]
  affiliateReferrals     AffiliateReferral[]
  affiliateCommissions   AffiliateCommission[]

  @@index([promoCode])
  @@index([email])
}

model InfluencerBankAccount {
  id            Int        @id @default(autoincrement())
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  influencerId  Int
  bankName      String
  accountNumber String // Encrypted
  routingNumber String // Encrypted
  accountType   String     @default("checking")
  isDefault     Boolean    @default(false)
  influencer    Influencer @relation(fields: [influencerId], references: [id])

  @@index([influencerId])
}

model ReferralTracking {
  id                  Int          @id @default(autoincrement())
  createdAt           DateTime     @default(now())
  clinicId            Int? // Multi-clinic support
  clinic              Clinic?      @relation(fields: [clinicId], references: [id])
  updatedAt           DateTime     @updatedAt
  patientId           Int          @unique
  influencerId        Int
  promoCode           String
  referralSource      String? // e.g., "instagram", "youtube", "tiktok"
  referralExpiresAt   DateTime // 90 days from creation
  isConverted         Boolean      @default(false)
  convertedAt         DateTime?
  conversionInvoiceId Int?         @unique
  metadata            Json? // Store additional tracking data
  patient             Patient      @relation(fields: [patientId], references: [id])
  influencer          Influencer   @relation(fields: [influencerId], references: [id])
  commissions         Commission[]

  @@index([influencerId])
  @@index([patientId])
  @@index([referralExpiresAt])
  @@index([isConverted])
}

model Commission {
  id               Int               @id @default(autoincrement())
  createdAt        DateTime          @default(now())
  clinicId         Int? // Multi-clinic support
  clinic           Clinic?           @relation(fields: [clinicId], references: [id])
  updatedAt        DateTime          @updatedAt
  influencerId     Int
  referralId       Int
  invoiceId        Int               @unique
  orderAmount      Int // Amount in cents
  commissionRate   Float // Rate at time of commission (e.g., 0.10 for 10%)
  commissionAmount Int // Calculated commission in cents
  status           CommissionStatus  @default(PENDING)
  payoutId         Int?
  notes            String?
  metadata         Json?
  influencer       Influencer        @relation(fields: [influencerId], references: [id])
  referral         ReferralTracking  @relation(fields: [referralId], references: [id])
  invoice          Invoice           @relation(fields: [invoiceId], references: [id])
  payout           CommissionPayout? @relation(fields: [payoutId], references: [id])

  @@index([influencerId])
  @@index([status])
  @@index([payoutId])
  @@index([invoiceId])
}

model CommissionPayout {
  id              Int          @id @default(autoincrement())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  influencerId    Int
  payoutMethod    String // "paypal", "bank_transfer", "check"
  payoutReference String? // Transaction ID, check number, etc.
  totalAmount     Int // Total payout amount in cents
  currency        String       @default("usd")
  status          PayoutStatus @default(PENDING)
  paidAt          DateTime?
  failureReason   String?
  notes           String?
  metadata        Json?
  influencer      Influencer   @relation(fields: [influencerId], references: [id])
  commissions     Commission[]

  @@index([influencerId])
  @@index([status])
}

enum InfluencerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
  DISPUTED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PatientDocumentCategory {
  MEDICAL_INTAKE_FORM
  MEDICAL_RECORDS
  LAB_RESULTS
  INSURANCE
  CONSENT_FORMS
  PRESCRIPTIONS
  IMAGING
  OTHER
}

enum WebhookStatus {
  SUCCESS
  ERROR
  INVALID_AUTH
  INVALID_PAYLOAD
  PROCESSING_ERROR
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SOAPNoteStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  LOCKED
  ARCHIVED
}

enum SOAPSourceType {
  MANUAL
  MEDLINK_INTAKE
  AI_GENERATED
  IMPORTED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
  EXPIRED
}

model WebhookLog {
  id               Int           @id @default(autoincrement())
  clinicId         Int? // Multi-clinic support
  clinic           Clinic?       @relation(fields: [clinicId], references: [id])
  endpoint         String
  method           String
  headers          Json?
  payload          Json?
  status           WebhookStatus
  statusCode       Int
  errorMessage     String?
  responseData     Json?
  ipAddress        String?
  userAgent        String?
  processingTimeMs Int?
  createdAt        DateTime      @default(now())

  @@index([endpoint, createdAt(sort: Desc)])
  @@index([status, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// Unified User Management System
model User {
  id                  Int                  @id @default(autoincrement())
  clinicId            Int? // Primary clinic (nullable for super admins)
  clinic              Clinic?              @relation(fields: [clinicId], references: [id])
  activeClinicId      Int? // Currently active clinic for multi-clinic users
  email               String               @unique
  passwordHash        String
  firstName           String
  lastName            String
  role                UserRole
  status              UserStatus           @default(ACTIVE)
  permissions         Json? // Custom permissions override
  features            Json? // Enabled features for this user
  metadata            Json? // Additional user metadata
  lastLogin           DateTime?
  lastPasswordChange  DateTime?
  failedLoginAttempts Int                  @default(0)
  lockedUntil         DateTime?
  
  // Two-Factor Authentication fields
  twoFactorEnabled     Boolean              @default(false)
  twoFactorSecret      String? // Encrypted TOTP secret
  twoFactorBackupCodes Json?                @default("[]") // Hashed backup codes (stored as JSON array)
  twoFactorVerifiedAt  DateTime? // When 2FA was last verified
  
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  createdById         Int?
  createdBy           User?                @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers        User[]               @relation("UserCreatedBy")
  auditLogs           UserAuditLog[]
  sessions            UserSession[]
  apiKeys             ApiKey[]
  systemSettings      SystemSettings[]
  integrations        Integration[]
  intakeTemplates     IntakeFormTemplate[]
  passwordResetTokens PasswordResetToken[]
  
  // Multi-clinic support
  userClinics         UserClinic[] // All clinics this user belongs to

  // Relations to existing models
  providerId   Int?        @unique
  influencerId Int?        @unique
  patientId    Int?        @unique
  provider     Provider?   @relation(fields: [providerId], references: [id])
  influencer   Influencer? @relation(fields: [influencerId], references: [id])
  patient      Patient?    @relation(fields: [patientId], references: [id])

  // Internal Communication Relations
  sentMessages        InternalMessage[]     @relation("SentMessages")
  receivedMessages    InternalMessage[]     @relation("ReceivedMessages")
  ticketsCreated      Ticket[]              @relation("TicketsCreated")
  ticketsAssigned     Ticket[]              @relation("TicketsAssigned")
  ticketsResolved     Ticket[]              @relation("TicketsResolved")
  ticketsOwned        Ticket[]              @relation("TicketsOwned")
  ticketsLastWorked   Ticket[]              @relation("TicketsLastWorked")
  assignmentsMade     TicketAssignment[]    @relation("AssignmentsMade")
  assignmentsReceived TicketAssignment[]    @relation("AssignmentsReceived")
  ticketComments      TicketComment[]       @relation("TicketComments")
  statusChanges       TicketStatusHistory[] @relation("StatusChanges")
  ticketWorkLogs      TicketWorkLog[]       @relation("TicketWorkLogs")
  escalationsMade     TicketEscalation[]    @relation("EscalationsMade")
  escalationsReceived TicketEscalation[]    @relation("EscalationsReceived")
  clinicAuditLogs     ClinicAuditLog[] // Multi-clinic audit logs
  
  // Scheduling & Care Plan Relations
  appointmentsCreated   Appointment[]        @relation("AppointmentCreatedBy")
  carePlanTemplates     CarePlanTemplate[]
  carePlanProgress      CarePlanProgress[]

  @@index([email])
  @@index([role, status])
  @@index([createdAt(sort: Desc)])
  @@index([clinicId])
  @@index([activeClinicId])
}

// Junction table for users belonging to multiple clinics
model UserClinic {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinicId  Int
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  role      UserRole // Role can be different per clinic
  isPrimary Boolean  @default(false) // Is this the user's primary clinic?
  isActive  Boolean  @default(true) // Is this assignment active?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, clinicId]) // User can only be assigned once per clinic
  @@index([userId])
  @@index([clinicId])
}

model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id])
  token        String   @unique
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())

  @@index([token])
  @@index([userId, expiresAt])
}

model UserAuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  action    String // LOGIN, LOGOUT, PASSWORD_CHANGE, PERMISSION_CHANGE, etc.
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
}

// General audit log for all system activities (HIPAA compliance)
model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String   // TWO_FACTOR_ENABLED, PHI_ACCESS, PRESCRIPTION_CREATED, etc.
  resource  String?  // Resource type (Patient, Order, etc.)
  resourceId Int?    // ID of the resource
  details   Json?    // Additional audit details
  ipAddress String?
  userAgent String?
  clinicId  Int?
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([resource, resourceId])
}

// Password Reset Token
model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  token     String    @unique // Hashed token
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  ipAddress String?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId, expiresAt])
}

// Phone OTP for SMS-based authentication
model PhoneOtp {
  id        Int       @id @default(autoincrement())
  phone     String    // Formatted phone number
  code      String    // 6-digit OTP code
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  userId    Int?      // If associated with a User
  patientId Int?      // If associated with a Patient
  ipAddress String?
  createdAt DateTime  @default(now())

  @@index([phone, code, expiresAt])
  @@index([phone])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROVIDER
  INFLUENCER
  PATIENT
  STAFF
  SUPPORT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  LOCKED
}

// Settings & Configuration System
model SystemSettings {
  id          Int      @id @default(autoincrement())
  clinicId    Int? // Multi-clinic support (null for global settings)
  clinic      Clinic?  @relation(fields: [clinicId], references: [id])
  category    String // general, security, integrations, notifications, etc.
  key         String
  value       Json
  description String?
  isPublic    Boolean  @default(false) // Can be exposed to non-admins
  isEncrypted Boolean  @default(false) // Should be encrypted at rest
  updatedAt   DateTime @updatedAt
  updatedById Int?
  updatedBy   User?    @relation(fields: [updatedById], references: [id])

  @@unique([category, key])
  @@index([category])
}

model Integration {
  id          Int               @id @default(autoincrement())
  clinicId    Int? // Multi-clinic support
  clinic      Clinic?           @relation(fields: [clinicId], references: [id])
  name        String            @unique
  provider    String // stripe, lifefile, twilio, sendgrid, etc.
  status      IntegrationStatus @default(INACTIVE)
  config      Json // Encrypted configuration
  credentials Json? // Encrypted credentials
  webhookUrl  String?
  lastSyncAt  DateTime?
  errorCount  Int               @default(0)
  lastError   String?
  metadata    Json?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdById Int?
  createdBy   User?             @relation(fields: [createdById], references: [id])
  apiKeys     ApiKey[]
  webhooks    WebhookConfig[]
  logs        IntegrationLog[]

  @@index([provider, status])
}

model ApiKey {
  id            Int           @id @default(autoincrement())
  clinicId      Int? // Multi-clinic support
  clinic        Clinic?       @relation(fields: [clinicId], references: [id])
  name          String
  key           String        @unique
  hashedKey     String // Store hashed version for security
  prefix        String // First 7 chars for identification
  permissions   Json // Specific permissions for this key
  rateLimit     Int           @default(1000) // Requests per hour
  expiresAt     DateTime?
  lastUsedAt    DateTime?
  lastUsedIp    String?
  status        ApiKeyStatus  @default(ACTIVE)
  integrationId Int?
  integration   Integration?  @relation(fields: [integrationId], references: [id])
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  createdAt     DateTime      @default(now())
  usageLogs     ApiUsageLog[]

  @@index([key])
  @@index([userId])
  @@index([status])
}

model ApiUsageLog {
  id           Int      @id @default(autoincrement())
  apiKeyId     Int
  apiKey       ApiKey   @relation(fields: [apiKeyId], references: [id])
  endpoint     String
  method       String
  statusCode   Int
  responseTime Int // in milliseconds
  ipAddress    String
  userAgent    String?
  requestBody  Json?
  responseBody Json?
  createdAt    DateTime @default(now())

  @@index([apiKeyId, createdAt(sort: Desc)])
  @@index([endpoint, createdAt(sort: Desc)])
}

model WebhookConfig {
  id            Int               @id @default(autoincrement())
  clinicId      Int? // Multi-clinic support
  clinic        Clinic?           @relation(fields: [clinicId], references: [id])
  name          String
  url           String
  events        Json // Array of event types to trigger
  headers       Json? // Custom headers
  secret        String? // For webhook signature verification
  isActive      Boolean           @default(true)
  retryPolicy   Json? // Retry configuration
  integrationId Int?
  integration   Integration?      @relation(fields: [integrationId], references: [id])
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deliveries    WebhookDelivery[]

  @@index([isActive])
}

model WebhookDelivery {
  id          Int                   @id @default(autoincrement())
  webhookId   Int
  webhook     WebhookConfig         @relation(fields: [webhookId], references: [id])
  event       String
  payload     Json
  status      WebhookDeliveryStatus
  attempts    Int                   @default(1)
  statusCode  Int?
  response    Json?
  error       String?
  deliveredAt DateTime?
  createdAt   DateTime              @default(now())

  @@index([webhookId, status])
  @@index([createdAt(sort: Desc)])
}

model IntegrationLog {
  id            Int         @id @default(autoincrement())
  integrationId Int
  integration   Integration @relation(fields: [integrationId], references: [id])
  action        String // sync, webhook_received, api_call, etc.
  status        String // success, error, warning
  message       String
  details       Json?
  createdAt     DateTime    @default(now())

  @@index([integrationId, createdAt(sort: Desc)])
  @@index([status, createdAt(sort: Desc)])
}

model DeveloperTool {
  id           Int       @id @default(autoincrement())
  name         String    @unique
  category     String // database, cache, queue, monitoring, etc.
  status       String // enabled, disabled, error
  config       Json
  lastCheckAt  DateTime?
  healthStatus Json? // Latest health check results
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([category])
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  MAINTENANCE
}

enum ApiKeyStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  REVOKED
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

// ===== INTAKE FORM SYSTEM =====

model IntakeFormTemplate {
  id               Int                     @id @default(autoincrement())
  createdAt        DateTime                @default(now())
  clinicId         Int? // Multi-clinic support
  clinic           Clinic?                 @relation(fields: [clinicId], references: [id])
  updatedAt        DateTime                @updatedAt
  name             String // e.g., "General Medical Intake", "Weight Loss Program Intake"
  description      String?
  treatmentType    String // e.g., "general", "weight-loss", "hormone-therapy", "aesthetic"
  isActive         Boolean                 @default(true)
  providerId       Int? // Optional: specific provider's form
  provider         Provider?               @relation(fields: [providerId], references: [id])
  createdById      Int? // User who created this template
  createdBy        User?                   @relation(fields: [createdById], references: [id])
  questions        IntakeFormQuestion[]
  submissions      IntakeFormSubmission[]
  formLinks        IntakeFormLink[]
  version          Int                     @default(1)
  metadata         Json? // Additional settings, styling, etc.
  appointmentTypes AppointmentTypeConfig[]

  @@index([treatmentType, isActive])
  @@index([providerId])
  @@index([createdById])
}

model IntakeFormQuestion {
  id               Int                  @id @default(autoincrement())
  createdAt        DateTime             @default(now())
  templateId       Int
  template         IntakeFormTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questionText     String
  questionType     String // "text", "textarea", "select", "radio", "checkbox", "date", "number", "email", "phone", "signature", "file"
  options          Json? // For select/radio/checkbox: ["Option 1", "Option 2"]
  isRequired       Boolean              @default(false)
  validation       Json? // { "min": 0, "max": 100, "pattern": "regex" }
  placeholder      String?
  helpText         String?
  orderIndex       Int                  @default(0)
  section          String? // Group questions into sections
  conditionalLogic Json? // Show/hide based on other answers
  responses        IntakeFormResponse[]

  @@index([templateId, orderIndex])
}

model IntakeFormSubmission {
  id             Int                  @id @default(autoincrement())
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  templateId     Int
  template       IntakeFormTemplate   @relation(fields: [templateId], references: [id])
  patientId      Int
  patient        Patient              @relation(fields: [patientId], references: [id])
  status         String               @default("pending") // "pending", "in_progress", "completed", "expired"
  completedAt    DateTime?
  formLinkId     String?              @unique
  formLink       IntakeFormLink?      @relation(fields: [formLinkId], references: [id])
  responses      IntakeFormResponse[]
  pdfUrl         String? // URL to generated PDF
  pdfGeneratedAt DateTime?
  metadata       Json? // IP address, device info, etc.
  signature      String? // Base64 signature image
  signedAt       DateTime?

  @@index([patientId, status])
  @@index([templateId])
}

model IntakeFormResponse {
  id           Int                  @id @default(autoincrement())
  createdAt    DateTime             @default(now())
  submissionId Int
  submission   IntakeFormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  questionId   Int
  question     IntakeFormQuestion   @relation(fields: [questionId], references: [id])
  answer       String? // Text answer or JSON for complex types
  fileUrl      String? // For file uploads

  @@unique([submissionId, questionId])
  @@index([submissionId])
}

model IntakeFormLink {
  id           String                @id @default(cuid())
  createdAt    DateTime              @default(now())
  expiresAt    DateTime
  templateId   Int
  template     IntakeFormTemplate    @relation(fields: [templateId], references: [id])
  patientEmail String
  patientPhone String?
  sentVia      String? // "email", "sms", "both"
  sentAt       DateTime?
  clickedAt    DateTime?
  submission   IntakeFormSubmission?
  isActive     Boolean               @default(true)
  metadata     Json? // Tracking info, utm params, etc.

  @@index([patientEmail, isActive])
  @@index([expiresAt])
}

// ===== PATIENT PROGRESS TRACKING =====

model PatientWeightLog {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  patientId  Int
  patient    Patient  @relation(fields: [patientId], references: [id])
  weight     Float // Weight in pounds
  unit       String   @default("lbs") // "lbs" or "kg"
  notes      String? // Optional notes from patient
  source     String   @default("patient") // "patient", "provider", "import"
  recordedAt DateTime @default(now()) // When the measurement was taken

  @@index([patientId, recordedAt])
}

model PatientMedicationReminder {
  id             Int       @id @default(autoincrement())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  patientId      Int
  patient        Patient   @relation(fields: [patientId], references: [id])
  medicationName String // e.g., "Semaglutide 0.5mg"
  dayOfWeek      Int // 0=Sunday, 1=Monday, etc.
  timeOfDay      String    @default("08:00") // HH:MM format
  isActive       Boolean   @default(true)
  lastTriggered  DateTime? // Last time reminder was sent
  metadata       Json? // Additional reminder settings

  @@unique([patientId, medicationName, dayOfWeek]) // One reminder per medication per day
  @@index([patientId, isActive])
}

model PatientWaterLog {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  clinicId   Int?
  clinic     Clinic?  @relation(fields: [clinicId], references: [id])
  patientId  Int
  patient    Patient  @relation(fields: [patientId], references: [id])
  amount     Float    // Amount in ounces
  unit       String   @default("oz") // "oz" or "ml"
  source     String   @default("patient") // "patient", "device", "import"
  recordedAt DateTime @default(now())
  notes      String?

  @@index([patientId, recordedAt])
  @@index([clinicId])
}

model PatientExerciseLog {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  clinicId     Int?
  clinic       Clinic?  @relation(fields: [clinicId], references: [id])
  patientId    Int
  patient      Patient  @relation(fields: [patientId], references: [id])
  activityType String   // "walking", "running", "cycling", "strength", "yoga", etc.
  duration     Int      // Duration in minutes
  intensity    String   @default("moderate") // "light", "moderate", "vigorous"
  calories     Int?     // Estimated calories burned
  steps        Int?     // Step count if applicable
  distance     Float?   // Distance in miles
  heartRateAvg Int?     // Average heart rate
  notes        String?
  source       String   @default("patient") // "patient", "device", "import"
  recordedAt   DateTime @default(now())

  @@index([patientId, recordedAt])
  @@index([clinicId])
}

model PatientSleepLog {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  clinicId    Int?
  clinic      Clinic?  @relation(fields: [clinicId], references: [id])
  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id])
  sleepStart  DateTime // When they went to bed
  sleepEnd    DateTime // When they woke up
  duration    Int      // Total sleep duration in minutes
  quality     Int?     // Sleep quality rating 1-10
  deepSleep   Int?     // Deep sleep minutes
  remSleep    Int?     // REM sleep minutes
  lightSleep  Int?     // Light sleep minutes
  awakeTime   Int?     // Time awake during sleep in minutes
  notes       String?
  source      String   @default("patient") // "patient", "device", "import"
  recordedAt  DateTime @default(now())

  @@index([patientId, recordedAt])
  @@index([clinicId])
}

model PatientNutritionLog {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  clinicId    Int?
  clinic      Clinic?  @relation(fields: [clinicId], references: [id])
  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id])
  mealType    String   // "breakfast", "lunch", "dinner", "snack"
  description String?  // What they ate
  calories    Int?     // Total calories
  protein     Float?   // Grams of protein
  carbs       Float?   // Grams of carbohydrates
  fat         Float?   // Grams of fat
  fiber       Float?   // Grams of fiber
  sugar       Float?   // Grams of sugar
  sodium      Float?   // Milligrams of sodium
  photoUrl    String?  // Optional photo of meal
  notes       String?
  source      String   @default("patient") // "patient", "import"
  recordedAt  DateTime @default(now())

  @@index([patientId, recordedAt])
  @@index([clinicId])
}

// ===== INTERNAL COMMUNICATION SYSTEM =====

model InternalMessage {
  id              Int                 @id @default(autoincrement())
  createdAt       DateTime            @default(now())
  clinicId        Int? // Multi-clinic support
  clinic          Clinic?             @relation(fields: [clinicId], references: [id])
  senderId        Int
  sender          User                @relation("SentMessages", fields: [senderId], references: [id])
  recipientId     Int? // Null for broadcast messages
  recipient       User?               @relation("ReceivedMessages", fields: [recipientId], references: [id])
  message         String
  isRead          Boolean             @default(false)
  readAt          DateTime?
  attachments     Json? // File URLs/references
  messageType     InternalMessageType @default(DIRECT)
  channelId       String? // For channel/group messages
  parentMessageId Int? // For threaded replies
  parentMessage   InternalMessage?    @relation("MessageThread", fields: [parentMessageId], references: [id])
  replies         InternalMessage[]   @relation("MessageThread")
  metadata        Json? // Additional context

  @@index([senderId, createdAt])
  @@index([recipientId, isRead])
  @@index([channelId, createdAt])
}

model Ticket {
  id           Int                @id @default(autoincrement())
  createdAt    DateTime           @default(now())
  clinicId     Int? // Multi-clinic support
  clinic       Clinic?            @relation(fields: [clinicId], references: [id])
  updatedAt    DateTime           @updatedAt
  ticketNumber String             @unique @default("")
  title        String
  description  String
  priority     TicketPriority     @default(MEDIUM)
  status       TicketStatus       @default(OPEN)
  disposition  TicketDisposition?
  category     TicketCategory     @default(GENERAL)

  // Related entities
  patientId        Int?
  patient          Patient? @relation(fields: [patientId], references: [id])
  orderId          Int?
  order            Order?   @relation(fields: [orderId], references: [id])
  isNonClientIssue Boolean  @default(false)

  // People involved
  createdById  Int
  createdBy    User  @relation("TicketsCreated", fields: [createdById], references: [id])
  assignedToId Int?
  assignedTo   User? @relation("TicketsAssigned", fields: [assignedToId], references: [id])

  // Activity tracking
  assignments   TicketAssignment[]
  comments      TicketComment[]
  statusHistory TicketStatusHistory[]
  workLogs      TicketWorkLog[]
  escalations   TicketEscalation[]
  sla           TicketSLA?

  // Ownership tracking
  currentOwnerId Int?
  currentOwner   User?     @relation("TicketsOwned", fields: [currentOwnerId], references: [id])
  lastWorkedById Int?
  lastWorkedBy   User?     @relation("TicketsLastWorked", fields: [lastWorkedById], references: [id])
  lastWorkedAt   DateTime?

  // Resolution
  resolvedAt      DateTime?
  resolvedById    Int?
  resolvedBy      User?     @relation("TicketsResolved", fields: [resolvedById], references: [id])
  resolutionNotes String?
  resolutionTime  Int? // Total time to resolution in minutes
  actualWorkTime  Int? // Actual time worked in minutes

  // Additional data
  tags         Json? // Array of tags
  customFields Json? // Custom field values
  attachments  Json? // File references

  @@index([status, priority, createdAt])
  @@index([assignedToId, status])
  @@index([patientId])
  @@index([ticketNumber])
}

model TicketAssignment {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  ticketId     Int
  ticket       Ticket   @relation(fields: [ticketId], references: [id])
  assignedById Int
  assignedBy   User     @relation("AssignmentsMade", fields: [assignedById], references: [id])
  assignedToId Int
  assignedTo   User     @relation("AssignmentsReceived", fields: [assignedToId], references: [id])
  notes        String?

  @@index([ticketId])
  @@index([assignedToId])
}

model TicketComment {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ticketId    Int
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
  authorId    Int
  author      User     @relation("TicketComments", fields: [authorId], references: [id])
  comment     String
  isInternal  Boolean  @default(false) // Internal notes vs customer-visible
  attachments Json? // File references

  @@index([ticketId, createdAt])
}

model TicketStatusHistory {
  id          Int          @id @default(autoincrement())
  createdAt   DateTime     @default(now())
  ticketId    Int
  ticket      Ticket       @relation(fields: [ticketId], references: [id])
  fromStatus  TicketStatus
  toStatus    TicketStatus
  changedById Int
  changedBy   User         @relation("StatusChanges", fields: [changedById], references: [id])
  reason      String?

  @@index([ticketId, createdAt])
}

model TicketWorkLog {
  id          Int          @id @default(autoincrement())
  createdAt   DateTime     @default(now())
  ticketId    Int
  ticket      Ticket       @relation(fields: [ticketId], references: [id])
  userId      Int
  user        User         @relation("TicketWorkLogs", fields: [userId], references: [id])
  action      TicketAction
  duration    Int? // Duration in minutes
  description String
  isInternal  Boolean      @default(true)
  metadata    Json? // Additional action-specific data

  @@index([ticketId, createdAt])
  @@index([userId, createdAt])
}

model TicketEscalation {
  id            Int       @id @default(autoincrement())
  createdAt     DateTime  @default(now())
  ticketId      Int
  ticket        Ticket    @relation(fields: [ticketId], references: [id])
  escalatedById Int
  escalatedBy   User      @relation("EscalationsMade", fields: [escalatedById], references: [id])
  escalatedToId Int
  escalatedTo   User      @relation("EscalationsReceived", fields: [escalatedToId], references: [id])
  level         Int       @default(1) // Escalation level (1, 2, 3, etc.)
  reason        String
  isActive      Boolean   @default(true)
  resolvedAt    DateTime?

  @@index([ticketId, isActive])
}

model TicketSLA {
  id               Int       @id @default(autoincrement())
  createdAt        DateTime  @default(now())
  ticketId         Int       @unique
  ticket           Ticket    @relation(fields: [ticketId], references: [id])
  firstResponseDue DateTime? // When first response is due
  firstResponseAt  DateTime? // When first response occurred
  resolutionDue    DateTime // When resolution is due
  resolvedAt       DateTime? // When actually resolved
  breached         Boolean   @default(false)
  breachReason     String?

  @@index([resolutionDue, breached])
}

// Enums for Internal Communication

enum InternalMessageType {
  DIRECT // One-to-one message
  BROADCAST // System-wide announcement
  CHANNEL // Channel/group message
  ALERT // Urgent notification
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  PENDING
  ON_HOLD
  ESCALATED
  RESOLVED
  CLOSED
  CANCELLED
}

enum TicketDisposition {
  RESOLVED_SUCCESSFULLY
  RESOLVED_WITH_WORKAROUND
  NOT_RESOLVED
  DUPLICATE
  NOT_REPRODUCIBLE
  BY_DESIGN
  CUSTOMER_ERROR
  TRAINING_ISSUE
  REFERRED_TO_SPECIALIST
  PENDING_CUSTOMER
  CANCELLED_BY_CUSTOMER
}

enum TicketCategory {
  GENERAL
  BILLING
  PRESCRIPTION
  APPOINTMENT
  TECHNICAL_ISSUE
  MEDICATION_QUESTION
  INSURANCE
  DELIVERY
  SIDE_EFFECTS
  DOSAGE
  REFILL
  PORTAL_ACCESS
  OTHER
}

enum TicketAction {
  CREATED
  ASSIGNED
  REASSIGNED
  STARTED_WORK
  STOPPED_WORK
  ADDED_COMMENT
  UPDATED_STATUS
  ESCALATED
  DE_ESCALATED
  REQUESTED_INFO
  PROVIDED_INFO
  RESEARCHED
  CONTACTED_PATIENT
  CONTACTED_PROVIDER
  CONTACTED_PHARMACY
  CONTACTED_INSURANCE
  APPLIED_SOLUTION
  TESTED_SOLUTION
  RESOLVED
  REOPENED
  CLOSED
  MERGED
  SPLIT
}

// ===== MULTI-CLINIC SUPPORT =====

model Clinic {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Information
  name         String
  subdomain    String       @unique
  customDomain String?      @unique
  status       ClinicStatus @default(ACTIVE)

  // Configuration
  settings     Json // UI settings, themes, branding
  features     Json // Enabled features per clinic
  integrations Json // API keys, webhooks per clinic

  // Stripe Connect Integration
  stripeAccountId          String?  @unique // Connected account ID (acct_xxx)
  stripeAccountStatus      String?  // 'pending', 'active', 'restricted', 'rejected'
  stripeOnboardingComplete Boolean  @default(false) // Has completed Stripe onboarding
  stripeChargesEnabled     Boolean  @default(false) // Can accept charges
  stripePayoutsEnabled     Boolean  @default(false) // Can receive payouts
  stripeDetailsSubmitted   Boolean  @default(false) // Has submitted account details
  stripePlatformAccount    Boolean  @default(false) // Is this the platform account (EONmeds)?
  stripeConnectedAt        DateTime? // When they connected their Stripe account
  
  // Lifefile Integration (per-clinic credentials - encrypted)
  lifefileBaseUrl          String? // API base URL
  lifefileUsername         String? // API username (encrypted)
  lifefilePassword         String? // API password (encrypted)
  lifefileVendorId         String? // Vendor ID
  lifefilePracticeId       String? // Practice ID
  lifefileLocationId       String? // Location ID (e.g., 110396 for logospharmacy)
  lifefileNetworkId        String? // Network ID
  lifefilePracticeName     String? // Practice name for prescriptions
  lifefilePracticeAddress  String? // Practice address
  lifefilePracticePhone    String? // Practice phone
  lifefilePracticeFax      String? // Practice fax
  lifefileWebhookSecret    String? // Webhook verification secret
  lifefileDatapushUsername String? // Data push webhook username
  lifefileDatapushPassword String? // Data push webhook password (encrypted)
  lifefileEnabled          Boolean @default(false) // Is Lifefile integration enabled?

  // Billing & Limits
  billingPlan   String @default("starter")
  patientLimit  Int    @default(100)
  providerLimit Int    @default(5)
  storageLimit  Int    @default(5000) // MB

  // Contact Information
  adminEmail   String
  supportEmail String?
  phone        String?
  address      Json? // {address1, address2, city, state, zip, country}
  timezone     String  @default("America/New_York")

  // Branding
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String  @default("#3B82F6")
  secondaryColor String  @default("#10B981")
  customCss      String? // Custom CSS overrides

  // Database Configuration (for future isolation)
  databaseUrl String? // Optional: for dedicated databases
  schemaName  String? // Optional: for schema-per-clinic

  // Relations
  users              User[]
  providers          Provider[]
  patients           Patient[]
  orders             Order[]
  tickets            Ticket[]
  intakeTemplates    IntakeFormTemplate[]
  invoices           Invoice[]
  payments           Payment[]
  paymentMethods     PaymentMethod[]
  subscriptions      Subscription[]
  soapNotes          SOAPNote[]
  documents          PatientDocument[]
  auditLogs          ClinicAuditLog[]
  aiConversations    AIConversation[]
  influencers        Influencer[]
  referralTrackings  ReferralTracking[]
  commissions        Commission[]
  internalMessages   InternalMessage[]
  webhookLogs        WebhookLog[]
  integrationConfigs Integration[]
  apiKeys            ApiKey[]
  webhookConfigs     WebhookConfig[]
  systemSettings     SystemSettings[]
  userClinics        UserClinic[] // Multi-clinic user assignments
  
  // Scheduling & Care Plan Relations
  appointments         Appointment[]
  appointmentTypes     AppointmentTypeConfig[]
  providerAvailability ProviderAvailability[]
  providerTimeOff      ProviderTimeOff[]
  superbills           Superbill[]
  billingCodes         BillingCode[]
  carePlans            CarePlan[]
  carePlanTemplates    CarePlanTemplate[]
  smsLogs              SmsLog[]
  patientChatMessages  PatientChatMessage[]
  
  // Health Tracking Logs
  waterLogs            PatientWaterLog[]
  exerciseLogs         PatientExerciseLog[]
  sleepLogs            PatientSleepLog[]
  nutritionLogs        PatientNutritionLog[]
  
  // Product Catalog
  products             Product[]
  
  // Pricing & Promotions
  discountCodes        DiscountCode[]
  promotions           Promotion[]
  productBundles       ProductBundle[]
  pricingRules         PricingRule[]
  affiliateProgram     AffiliateProgram?
  affiliateReferrals   AffiliateReferral[]
  affiliateCommissions AffiliateCommission[]
  retentionOffers      RetentionOffer[]

  @@index([subdomain])
  @@index([status])
  @@index([customDomain])
}

model ClinicAuditLog {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  clinicId  Int
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  action    String // CREATE, UPDATE, DELETE, STATUS_CHANGE, BILLING_CHANGE, etc.
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  details   Json? // Detailed change information
  ipAddress String?
  userAgent String?

  @@index([clinicId, createdAt])
  @@index([action])
}

enum ClinicStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
  PENDING_SETUP
}

// ===== SCHEDULING SYSTEM =====

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum AppointmentModeType {
  IN_PERSON
  VIDEO
  PHONE
}

enum ReminderType {
  EMAIL
  SMS
  BOTH
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

model AppointmentTypeConfig {
  id                   Int                  @id @default(autoincrement())
  clinicId             Int?
  clinic               Clinic?              @relation(fields: [clinicId], references: [id])
  name                 String
  description          String?
  duration             Int                  @default(30) // in minutes
  color                String               @default("#3B82F6")
  isActive             Boolean              @default(true)
  requiresVideoLink    Boolean              @default(false)
  allowSelfScheduling  Boolean              @default(true)
  bufferBefore         Int                  @default(0) // minutes before
  bufferAfter          Int                  @default(0) // minutes after
  price                Int? // in cents
  intakeFormTemplateId Int?
  intakeFormTemplate   IntakeFormTemplate?  @relation(fields: [intakeFormTemplateId], references: [id])
  appointments         Appointment[]
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([clinicId])
}

model ProviderAvailability {
  id               Int       @id @default(autoincrement())
  providerId       Int
  provider         Provider  @relation(fields: [providerId], references: [id])
  clinicId         Int?
  clinic           Clinic?   @relation(fields: [clinicId], references: [id])
  dayOfWeek        Int // 0 = Sunday, 6 = Saturday
  startTime        String // "09:00"
  endTime          String // "17:00"
  isActive         Boolean   @default(true)
  locationId       Int?
  appointmentTypes Json? // Array of allowed appointment type IDs
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([providerId])
  @@index([dayOfWeek])
}

model ProviderTimeOff {
  id          Int      @id @default(autoincrement())
  providerId  Int
  provider    Provider @relation(fields: [providerId], references: [id])
  clinicId    Int?
  clinic      Clinic?  @relation(fields: [clinicId], references: [id])
  startDate   DateTime
  endDate     DateTime
  startTime   DateTime?
  endTime     DateTime?
  reason      String?
  isApproved  Boolean  @default(true)
  isAllDay    Boolean  @default(false)
  isRecurring Boolean  @default(false)
  source      String?  // 'manual', 'calendar_sync'
  createdAt   DateTime @default(now())

  @@index([providerId])
  @@index([startDate, endDate])
}

model ProviderCalendarIntegration {
  id            Int      @id @default(autoincrement())
  providerId    Int
  provider      String   // 'google', 'outlook'
  clinicId      Int?
  accessToken   String?
  refreshToken  String?
  expiresAt     DateTime?
  accountId     String?
  calendarId    String?  @default("primary")
  isActive      Boolean  @default(true)
  syncEnabled   Boolean  @default(true)
  syncDirection String   @default("both") // 'to_external', 'from_external', 'both'
  lastSyncAt    DateTime?
  lastError     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([providerId, provider], name: "providerId_provider")
  @@index([providerId])
}

model Appointment {
  id                  Int                    @id @default(autoincrement())
  clinicId            Int?
  clinic              Clinic?                @relation(fields: [clinicId], references: [id])
  patientId           Int
  patient             Patient                @relation(fields: [patientId], references: [id])
  providerId          Int
  provider            Provider               @relation(fields: [providerId], references: [id])
  appointmentTypeId   Int?
  appointmentType     AppointmentTypeConfig? @relation(fields: [appointmentTypeId], references: [id])
  title               String?
  startTime           DateTime
  endTime             DateTime
  duration            Int                    @default(30)
  type                AppointmentModeType    @default(IN_PERSON)
  status              AppointmentStatus      @default(SCHEDULED)
  reason              String?
  notes               String? // Patient-visible notes
  internalNotes       String? // Provider-only notes
  location            String?
  roomNumber          String?
  videoLink           String?
  zoomMeetingId       String?
  confirmedAt         DateTime?
  checkedInAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?
  rescheduledFromId   Int?
  rescheduledToId     Int?
  noShowAt            DateTime?
  createdById         Int?
  createdBy           User?                  @relation("AppointmentCreatedBy", fields: [createdById], references: [id])
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  metadata            Json?
  reminders              AppointmentReminder[]
  superbills             Superbill[]
  googleCalendarEventId  String?
  outlookCalendarEventId String?
  zoomJoinUrl            String?

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([startTime])
  @@index([status])
}

model AppointmentReminder {
  id            Int            @id @default(autoincrement())
  appointmentId Int
  appointment   Appointment    @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  type          ReminderType   @default(BOTH)
  scheduledFor  DateTime
  status        ReminderStatus @default(PENDING)
  sentAt        DateTime?
  errorMessage  String?
  messageId     String? // Twilio message ID or email ID
  template      String? // Which template was used
  createdAt     DateTime       @default(now())

  @@index([appointmentId])
  @@index([scheduledFor, status])
}

// ===== SUPERBILL / INSURANCE SYSTEM =====

model Superbill {
  id            Int             @id @default(autoincrement())
  clinicId      Int?
  clinic        Clinic?         @relation(fields: [clinicId], references: [id])
  patientId     Int
  patient       Patient         @relation(fields: [patientId], references: [id])
  providerId    Int
  provider      Provider        @relation(fields: [providerId], references: [id])
  appointmentId Int?
  appointment   Appointment?    @relation(fields: [appointmentId], references: [id])
  serviceDate   DateTime
  totalAmount   Int             @default(0) // in cents
  paidAmount    Int             @default(0) // in cents
  status        String          @default("DRAFT") // DRAFT, FINALIZED, SENT, PAID
  pdfUrl        String?
  pdfGeneratedAt DateTime?
  sentToPatient Boolean         @default(false)
  sentAt        DateTime?
  notes         String?
  items         SuperbillItem[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([serviceDate])
}

model SuperbillItem {
  id              Int       @id @default(autoincrement())
  superbillId     Int
  superbill       Superbill @relation(fields: [superbillId], references: [id], onDelete: Cascade)
  cptCode         String
  cptDescription  String
  icdCodes        String[] // Array of ICD-10 codes
  icdDescriptions String[] // Array of ICD-10 descriptions
  modifier        String? // CPT modifier (e.g., "25")
  units           Int       @default(1)
  unitPrice       Int // in cents
  totalPrice      Int // in cents
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([superbillId])
}

model BillingCode {
  id           Int      @id @default(autoincrement())
  clinicId     Int?
  clinic       Clinic?  @relation(fields: [clinicId], references: [id])
  codeType     String // "CPT" or "ICD10"
  code         String
  description  String
  defaultPrice Int? // in cents (for CPT)
  category     String? // e.g., "Evaluation", "Procedure", "Lab"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([clinicId, codeType, code])
}

// ===== CARE PLAN SYSTEM =====

enum CarePlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
  CANCELLED
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
  CANCELLED
}

model CarePlan {
  id                Int               @id @default(autoincrement())
  clinicId          Int?
  clinic            Clinic?           @relation(fields: [clinicId], references: [id])
  patientId         Int
  patient           Patient           @relation(fields: [patientId], references: [id])
  providerId        Int?
  provider          Provider?         @relation(fields: [providerId], references: [id])
  title             String
  description       String?
  status            CarePlanStatus    @default(DRAFT)
  startDate         DateTime?
  endDate           DateTime?
  templateId        Int?
  template          CarePlanTemplate? @relation(fields: [templateId], references: [id])
  pdfUrl            String?
  patientSignature  String? // Base64 signature
  patientSignedAt   DateTime?
  providerSignature String?
  providerSignedAt  DateTime?
  activatedAt       DateTime?
  completedAt       DateTime?
  notes             String?
  metadata          Json?
  goals             CarePlanGoal[]
  activities        CarePlanActivity[]
  progress          CarePlanProgress[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
}

model CarePlanTemplate {
  id                  Int        @id @default(autoincrement())
  clinicId            Int?
  clinic              Clinic?    @relation(fields: [clinicId], references: [id])
  name                String
  description         String?
  treatmentType       String? // e.g., "weight-loss", "hormone-therapy"
  defaultDurationDays Int?       @default(90)
  isActive            Boolean    @default(true)
  content             Json // Template structure with goals, activities
  createdById         Int?
  createdBy           User?      @relation(fields: [createdById], references: [id])
  carePlans           CarePlan[]
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  @@index([clinicId])
}

model CarePlanGoal {
  id           Int                @id @default(autoincrement())
  carePlanId   Int
  carePlan     CarePlan           @relation(fields: [carePlanId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  targetValue  String? // e.g., "180" for target weight
  currentValue String? // e.g., "200" for current weight
  unit         String? // e.g., "lbs", "mg/dL"
  status       GoalStatus         @default(NOT_STARTED)
  targetDate   DateTime?
  completedAt  DateTime?
  orderIndex   Int                @default(0)
  activities   CarePlanActivity[]
  progress     CarePlanProgress[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([carePlanId])
}

model CarePlanActivity {
  id           Int                @id @default(autoincrement())
  carePlanId   Int
  carePlan     CarePlan           @relation(fields: [carePlanId], references: [id], onDelete: Cascade)
  goalId       Int?
  goal         CarePlanGoal?      @relation(fields: [goalId], references: [id])
  title        String
  description  String?
  frequency    String? // e.g., "daily", "weekly", "3x per week"
  instructions String?
  orderIndex   Int                @default(0)
  progress     CarePlanProgress[]
  createdAt    DateTime           @default(now())

  @@index([carePlanId])
}

model CarePlanProgress {
  id                Int               @id @default(autoincrement())
  carePlanId        Int
  carePlan          CarePlan          @relation(fields: [carePlanId], references: [id], onDelete: Cascade)
  goalId            Int?
  goal              CarePlanGoal?     @relation(fields: [goalId], references: [id])
  activityId        Int?
  activity          CarePlanActivity? @relation(fields: [activityId], references: [id])
  value             String? // Recorded value
  notes             String?
  recordedById      Int?
  recordedBy        User?             @relation(fields: [recordedById], references: [id])
  recordedByPatient Boolean           @default(false)
  recordedAt        DateTime          @default(now())

  @@index([carePlanId])
  @@index([recordedAt])
}

// ===== SMS MESSAGE LOG =====

model SmsLog {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  clinicId    Int?
  clinic      Clinic?   @relation(fields: [clinicId], references: [id])
  patientId   Int?
  patient     Patient?  @relation(fields: [patientId], references: [id])
  messageSid  String?   @unique // Twilio message SID
  fromPhone   String    // Sender phone number
  toPhone     String    // Recipient phone number
  body        String    // Message content
  direction   String    // 'inbound' or 'outbound'
  status      String    @default("sent") // sent, delivered, failed, etc.
  error       String?   // Error message if failed
  metadata    Json?     // Additional data
  
  @@index([patientId, createdAt])
  @@index([fromPhone])
  @@index([toPhone])
  @@index([clinicId])
}

// ===== PATIENT CHAT SYSTEM =====

model PatientChatMessage {
  id              Int             @id @default(autoincrement())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  clinicId        Int?
  clinic          Clinic?         @relation(fields: [clinicId], references: [id])
  patientId       Int
  patient         Patient         @relation(fields: [patientId], references: [id])
  
  // Message content
  message         String          // The message text
  direction       MessageDirection // INBOUND (patient->staff) or OUTBOUND (staff->patient)
  channel         MessageChannel   @default(WEB) // WEB, SMS, EMAIL
  
  // Sender info
  senderType      SenderType      // PATIENT, STAFF, PROVIDER, SYSTEM
  senderId        Int?            // User ID if staff/provider, null if patient
  senderName      String?         // Display name of sender
  
  // Delivery status (for SMS/email)
  status          MessageStatus   @default(SENT)
  externalId      String?         // Twilio message SID or external reference
  deliveredAt     DateTime?
  readAt          DateTime?
  failureReason   String?
  
  // Thread support
  threadId        String?         // Group messages into threads
  replyToId       Int?            // Reply to specific message
  replyTo         PatientChatMessage?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies         PatientChatMessage[] @relation("MessageReplies")
  
  // Attachments
  attachments     Json?           // Array of attachment URLs
  
  // Metadata
  metadata        Json?           // Additional data (device info, etc.)
  
  @@index([patientId, createdAt])
  @@index([clinicId])
  @@index([threadId])
  @@index([status])
}

enum MessageDirection {
  INBOUND   // Patient -> Staff
  OUTBOUND  // Staff -> Patient
}

enum MessageChannel {
  WEB       // In-app web chat
  SMS       // Twilio SMS
  EMAIL     // Email
}

enum SenderType {
  PATIENT
  STAFF
  PROVIDER
  SYSTEM
}

enum MessageStatus {
  PENDING     // Queued for delivery
  SENT        // Sent but not confirmed delivered
  DELIVERED   // Confirmed delivered
  READ        // Read by recipient
  FAILED      // Delivery failed
}

// ===== PRODUCT CATALOG =====

model Product {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Basic Information
  name               String            // e.g., "Semaglutide 0-1.25mg Monthly"
  description        String?           // Detailed description
  shortDescription   String?           // For invoices/receipts
  category           ProductCategory   @default(SERVICE)
  
  // Pricing
  price              Int               // Price in cents
  currency           String            @default("usd")
  
  // Billing Type
  billingType        BillingType       @default(ONE_TIME)
  billingInterval    BillingInterval?  // For recurring: MONTHLY, QUARTERLY, etc.
  billingIntervalCount Int             @default(1) // e.g., 3 for quarterly (3 months)
  
  // Trial Period (for subscriptions)
  trialDays          Int?              // Optional trial period
  
  // Stripe Integration
  stripeProductId    String?           @unique // Stripe Product ID
  stripePriceId      String?           @unique // Stripe Price ID
  
  // Status & Visibility
  isActive           Boolean           @default(true)
  isVisible          Boolean           @default(true) // Show in patient-facing catalog
  displayOrder       Int               @default(0)   // For sorting
  
  // Inventory (optional)
  trackInventory     Boolean           @default(false)
  inventoryCount     Int?
  lowStockThreshold  Int?
  
  // Tax
  taxable            Boolean           @default(false)
  taxRate            Float?            // e.g., 0.07 for 7%
  
  // Metadata
  metadata           Json?             // Additional custom data
  tags               Json?             // Array of tags for filtering
  
  // Relations
  invoiceItems       InvoiceItem[]
  bundleItems        ProductBundleItem[]
  
  @@index([clinicId, isActive])
  @@index([clinicId, category])
  @@index([stripeProductId])
}

model InvoiceItem {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  invoiceId   Int
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId   Int?
  product     Product?  @relation(fields: [productId], references: [id])
  description String    // Line item description
  quantity    Int       @default(1)
  unitPrice   Int       // Price per unit in cents
  amount      Int       // Total amount (quantity * unitPrice)
  metadata    Json?
  
  @@index([invoiceId])
  @@index([productId])
}

enum ProductCategory {
  SERVICE        // Medical services, consultations
  MEDICATION     // Prescription medications
  SUPPLEMENT     // OTC supplements
  LAB_TEST       // Lab work, tests
  PROCEDURE      // Medical procedures
  PACKAGE        // Bundled services
  MEMBERSHIP     // Membership/subscription plans
  OTHER
}

enum BillingType {
  ONE_TIME       // Single payment
  RECURRING      // Subscription
}

enum BillingInterval {
  WEEKLY
  MONTHLY
  QUARTERLY      // Every 3 months
  SEMI_ANNUAL    // Every 6 months
  ANNUAL         // Yearly
  CUSTOM         // Custom interval using billingIntervalCount
}

// ===== DISCOUNT & PROMO CODE SYSTEM =====

model DiscountCode {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Code Details
  code               String            // e.g., "WELCOME20", "SUMMER2026"
  name               String            // Display name: "Welcome Discount"
  description        String?           // Internal description
  
  // Discount Type
  discountType       DiscountType      @default(PERCENTAGE)
  discountValue      Float             // 20 for 20% or 2000 for $20 off (cents)
  
  // Applicability
  applyTo            DiscountApplyTo   @default(ALL_PRODUCTS)
  productIds         Json?             // Specific product IDs if LIMITED_PRODUCTS
  categoryIds        Json?             // Specific categories if LIMITED_CATEGORIES
  excludeProductIds  Json?             // Products to exclude
  
  // Usage Limits
  maxUses            Int?              // Total uses allowed (null = unlimited)
  maxUsesPerPatient  Int?              // Per patient limit (null = unlimited)
  currentUses        Int               @default(0)
  
  // Validity
  startsAt           DateTime          @default(now())
  expiresAt          DateTime?         // null = never expires
  isActive           Boolean           @default(true)
  
  // Requirements
  minOrderAmount     Int?              // Minimum order in cents
  minQuantity        Int?              // Minimum quantity of items
  firstTimeOnly      Boolean           @default(false) // Only for new patients
  
  // Subscription Specifics
  applyToFirstPayment  Boolean         @default(true)
  applyToRecurring     Boolean         @default(false)
  recurringDuration    Int?            // How many billing cycles to apply (null = all)
  
  // Stripe Integration
  stripeCouponId     String?           @unique
  
  // Tracking
  affiliateId        Int?              // If code belongs to affiliate
  affiliate          Influencer?       @relation(fields: [affiliateId], references: [id])
  
  // Usage Records
  usages             DiscountUsage[]
  
  @@unique([clinicId, code])
  @@index([clinicId, isActive])
  @@index([code])
  @@index([affiliateId])
}

model DiscountUsage {
  id              Int           @id @default(autoincrement())
  createdAt       DateTime      @default(now())
  discountCodeId  Int
  discountCode    DiscountCode  @relation(fields: [discountCodeId], references: [id])
  patientId       Int
  patient         Patient       @relation(fields: [patientId], references: [id])
  invoiceId       Int?
  orderId         Int?
  amountSaved     Int           // Amount saved in cents
  orderTotal      Int           // Original order total
  
  @@index([discountCodeId])
  @@index([patientId])
}

enum DiscountType {
  PERCENTAGE        // % off
  FIXED_AMOUNT      // $ off
  FREE_SHIPPING     // Free shipping
  FREE_TRIAL        // Extended trial period
  BUY_X_GET_Y       // Buy X get Y free/discounted
}

enum DiscountApplyTo {
  ALL_PRODUCTS
  LIMITED_PRODUCTS    // Specific products only
  LIMITED_CATEGORIES  // Specific categories only
  SUBSCRIPTIONS_ONLY  // Only recurring products
  ONE_TIME_ONLY       // Only one-time products
}

// ===== PROMOTIONS & SPECIALS =====

model Promotion {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Basic Info
  name               String            // "Summer Sale 2026"
  description        String?
  internalNotes      String?
  
  // Promotion Type
  promotionType      PromotionType     @default(SALE)
  
  // Discount Configuration
  discountType       DiscountType      @default(PERCENTAGE)
  discountValue      Float
  
  // Applicability
  applyTo            DiscountApplyTo   @default(ALL_PRODUCTS)
  productIds         Json?
  categoryIds        Json?
  
  // Schedule
  startsAt           DateTime
  endsAt             DateTime?
  isActive           Boolean           @default(true)
  
  // Display
  bannerText         String?           // "Save 20% - Limited Time!"
  bannerColor        String?           // Hex color for banner
  showOnProducts     Boolean           @default(true)
  showBanner         Boolean           @default(false)
  
  // Limits
  maxRedemptions     Int?
  currentRedemptions Int               @default(0)
  
  // Auto-apply
  autoApply          Boolean           @default(true) // Automatically apply vs. need code
  requiresCode       Boolean           @default(false)
  discountCodeId     Int?              // If requires code
  
  // Stripe
  stripeCouponId     String?
  
  @@index([clinicId, isActive])
  @@index([startsAt, endsAt])
}

enum PromotionType {
  SALE              // General sale
  FLASH_SALE        // Limited time (hours)
  SEASONAL          // Holiday/seasonal
  CLEARANCE         // Clearance pricing
  NEW_PATIENT       // New patient special
  LOYALTY           // Loyalty reward
  BUNDLE            // Bundle deal
  UPGRADE           // Upgrade offer
}

// ===== PRODUCT BUNDLES =====

model ProductBundle {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Bundle Info
  name               String            // "3-Month Weight Loss Program"
  description        String?
  shortDescription   String?
  
  // Pricing
  regularPrice       Int               // Sum of individual products (cents)
  bundlePrice        Int               // Discounted bundle price
  savingsAmount      Int               // How much they save
  savingsPercent     Float             // Percentage saved
  
  // Products in Bundle
  items              ProductBundleItem[]
  
  // Billing
  billingType        BillingType       @default(ONE_TIME)
  billingInterval    BillingInterval?
  
  // Status
  isActive           Boolean           @default(true)
  isVisible          Boolean           @default(true)
  displayOrder       Int               @default(0)
  
  // Stripe
  stripeProductId    String?           @unique
  stripePriceId      String?           @unique
  
  // Limits
  maxPurchases       Int?              // Max times can be purchased
  currentPurchases   Int               @default(0)
  availableFrom      DateTime?
  availableUntil     DateTime?
  
  @@index([clinicId, isActive])
}

model ProductBundleItem {
  id          Int           @id @default(autoincrement())
  bundleId    Int
  bundle      ProductBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product       @relation(fields: [productId], references: [id])
  quantity    Int           @default(1)
  
  @@index([bundleId])
  @@index([productId])
}

// ===== PRICING RULES ENGINE =====

model PricingRule {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Rule Info
  name               String            // "Volume Discount Tier 1"
  description        String?
  priority           Int               @default(0) // Higher = applied first
  
  // Rule Type
  ruleType           PricingRuleType   @default(VOLUME_DISCOUNT)
  
  // Conditions (JSON for flexibility)
  conditions         Json              // Array of condition objects
  // Example: [{"type": "quantity", "operator": ">=", "value": 5}]
  // Example: [{"type": "patientTag", "operator": "contains", "value": "VIP"}]
  
  // Action
  discountType       DiscountType      @default(PERCENTAGE)
  discountValue      Float
  
  // Applicability
  applyTo            DiscountApplyTo   @default(ALL_PRODUCTS)
  productIds         Json?
  
  // Status
  isActive           Boolean           @default(true)
  startsAt           DateTime?
  endsAt             DateTime?
  
  @@index([clinicId, isActive, priority])
}

enum PricingRuleType {
  VOLUME_DISCOUNT     // Buy more, save more
  TIERED_PRICING      // Price decreases at quantity thresholds
  PATIENT_SEGMENT     // Based on patient attributes/tags
  LOYALTY_DISCOUNT    // Based on purchase history
  TIME_BASED          // Different prices at different times
  LOCATION_BASED      // Based on patient location
  CUSTOM              // Custom rule logic
}

// ===== AFFILIATE/REFERRAL PROGRAM ENHANCEMENTS =====

model AffiliateProgram {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  clinicId           Int               @unique
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Program Settings
  name               String            @default("Affiliate Program")
  isActive           Boolean           @default(true)
  
  // Default Commission
  defaultCommissionType   CommissionType  @default(PERCENTAGE)
  defaultCommissionValue  Float           @default(10) // 10% or $10
  
  // Commission Rules
  commissionOnFirstPurchase  Boolean   @default(true)
  commissionOnRecurring      Boolean   @default(true)
  recurringCommissionDuration Int?     // Months to pay recurring (null = lifetime)
  
  // Cookie/Attribution
  attributionWindowDays   Int          @default(30) // Days to attribute sale
  
  // Tiers
  tiers              AffiliateTier[]
  
  // Payouts
  minimumPayout      Int               @default(5000) // $50 minimum
  payoutFrequency    PayoutFrequency   @default(MONTHLY)
  
  @@index([clinicId])
}

model AffiliateTier {
  id                 Int               @id @default(autoincrement())
  programId          Int
  program            AffiliateProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  // Tier Info
  name               String            // "Bronze", "Silver", "Gold", "Platinum"
  level              Int               @default(1) // 1, 2, 3, 4...
  
  // Requirements
  minReferrals       Int               @default(0) // Min referrals to reach tier
  minRevenue         Int               @default(0) // Min revenue generated (cents)
  
  // Benefits
  commissionType     CommissionType    @default(PERCENTAGE)
  commissionValue    Float             // Commission rate for this tier
  bonusAmount        Int?              // One-time bonus for reaching tier
  
  // Perks
  perks              Json?             // Array of perk descriptions
  
  @@unique([programId, level])
  @@index([programId])
}

model AffiliateReferral {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Referral Details
  affiliateId        Int               // The influencer/affiliate
  affiliate          Influencer        @relation(fields: [affiliateId], references: [id])
  referredPatientId  Int               // The patient who was referred
  referredPatient    Patient           @relation(fields: [referredPatientId], references: [id])
  
  // Attribution
  discountCodeUsed   String?           // Code they used
  landingPage        String?           // Where they landed
  utmSource          String?
  utmMedium          String?
  utmCampaign        String?
  
  // Status
  status             ReferralStatus    @default(PENDING)
  convertedAt        DateTime?         // When they made first purchase
  
  // Lifetime Value
  totalRevenue       Int               @default(0) // Total revenue from this referral
  totalCommission    Int               @default(0) // Total commission paid
  
  @@index([affiliateId])
  @@index([referredPatientId])
  @@index([clinicId])
}

model AffiliateCommission {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Commission Details
  affiliateId        Int
  affiliate          Influencer        @relation(fields: [affiliateId], references: [id])
  referralId         Int?
  
  // Source
  invoiceId          Int?
  orderId            Int?
  subscriptionId     Int?
  
  // Amounts
  orderAmount        Int               // Order/payment amount
  commissionRate     Float             // Rate applied
  commissionAmount   Int               // Commission earned
  
  // Status
  status             CommissionStatus  @default(PENDING)
  paidAt             DateTime?
  payoutId           String?           // External payout reference
  
  // Type
  commissionType     String            @default("first_purchase") // first_purchase, recurring, bonus
  
  @@index([affiliateId])
  @@index([clinicId])
  @@index([status])
}

enum CommissionType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PayoutFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

enum ReferralStatus {
  PENDING       // Signed up but no purchase
  CONVERTED     // Made first purchase
  ACTIVE        // Active customer
  CHURNED       // Cancelled/inactive
}

// ===== SUBSCRIPTION MANAGEMENT =====

model SubscriptionAction {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  subscriptionId     Int
  subscription       Subscription      @relation(fields: [subscriptionId], references: [id])
  
  // Action Details
  actionType         SubscriptionActionType
  reason             String?
  
  // For Pauses
  pausedUntil        DateTime?
  
  // For Plan Changes
  previousPlanId     String?
  newPlanId          String?
  previousAmount     Int?
  newAmount          Int?
  
  // For Cancellation
  cancellationReason String?
  retentionOfferMade Boolean           @default(false)
  retentionOfferId   Int?
  
  // Who performed
  performedBy        String?           // user ID or "system" or "patient"
  
  @@index([subscriptionId])
}

model RetentionOffer {
  id                 Int               @id @default(autoincrement())
  createdAt          DateTime          @default(now())
  clinicId           Int
  clinic             Clinic            @relation(fields: [clinicId], references: [id])
  
  // Offer Info
  name               String            // "Stay with us - 50% off next month"
  description        String?
  
  // Offer Type
  offerType          RetentionOfferType @default(DISCOUNT)
  
  // Discount (if applicable)
  discountType       DiscountType?
  discountValue      Float?
  discountDuration   Int?              // How many billing cycles
  
  // Free Period (if applicable)
  freeMonths         Int?
  
  // Pause Option
  pauseDuration      Int?              // Days to pause
  
  // Targeting
  triggerOn          String            @default("cancellation") // cancellation, payment_failed, etc.
  minSubscriptionAge Int?              // Min days subscribed to show offer
  
  // Status
  isActive           Boolean           @default(true)
  
  // Stats
  timesShown         Int               @default(0)
  timesAccepted      Int               @default(0)
  
  @@index([clinicId, isActive])
}

enum SubscriptionActionType {
  CREATED
  ACTIVATED
  PAUSED
  RESUMED
  UPGRADED
  DOWNGRADED
  CANCELLED
  REACTIVATED
  PAYMENT_FAILED
  PAYMENT_SUCCEEDED
  RETENTION_OFFERED
  RETENTION_ACCEPTED
  RETENTION_DECLINED
}

enum RetentionOfferType {
  DISCOUNT          // Percentage or fixed off
  FREE_PERIOD       // Free month(s)
  PAUSE             // Pause subscription
  DOWNGRADE         // Offer cheaper plan
  BONUS             // Free add-on product
}
