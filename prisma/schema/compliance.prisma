// ==========================================================================
// COMPLIANCE DOMAIN
// ==========================================================================
// Bounded context: compliance
// Part of multi-file Prisma schema (prisma/schema/)
// ==========================================================================

// Policy definitions for SOC 2 compliance
model Policy {
  id               Int      @id @default(autoincrement())
  policyId         String   @unique // e.g., "POL-001"
  title            String
  version          String // e.g., "1.0"
  effectiveDate    DateTime
  content          String // Full policy markdown
  contentHash      String // SHA-256 hash for tamper detection
  status           String   @default("draft") // draft, active, superseded
  requiresApproval Boolean  @default(true)
  approvalRoles    String[] // Roles required to approve
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  PolicyApproval       PolicyApproval[]
  PolicyAcknowledgment PolicyAcknowledgment[]

  @@index([status])
  @@index([policyId])
}

// Executive policy approvals (digital signatures)
model PolicyApproval {
  id                    Int      @id @default(autoincrement())
  policyId              Int
  policy                Policy   @relation(fields: [policyId], references: [id])
  userId                Int
  user                  User     @relation(fields: [userId], references: [id])
  userEmail             String
  userName              String
  userRole              String
  approvalType          String // executive_approval, ciso_approval, compliance_approval
  ipAddress             String
  userAgent             String?
  contentHashAtApproval String // Hash when approved (tamper detection)
  signatureStatement    String // Legal statement agreed to
  approvedAt            DateTime @default(now())

  @@unique([policyId, userId, approvalType])
  @@index([policyId])
  @@index([userId])
  @@index([approvedAt])
}

// Employee policy acknowledgments
model PolicyAcknowledgment {
  id                          Int      @id @default(autoincrement())
  policyId                    Int
  policy                      Policy   @relation(fields: [policyId], references: [id])
  userId                      Int
  user                        User     @relation(fields: [userId], references: [id])
  userEmail                   String
  userName                    String
  userRole                    String
  clinicId                    Int?
  clinic                      Clinic?  @relation(fields: [clinicId], references: [id])
  ipAddress                   String
  userAgent                   String?
  contentHashAtAcknowledgment String // Hash when acknowledged
  acknowledgedAt              DateTime @default(now())

  @@unique([policyId, userId])
  @@index([policyId])
  @@index([userId])
  @@index([clinicId])
  @@index([acknowledgedAt])
}

model AddressValidationLog {
  id Int @id @default(autoincrement())

  // Event Classification
  eventType   String // PARSE_SUCCESS, SMARTY_VALIDATED, etc.
  source      String // webhook, intake, manual, migration
  inputFormat String // combined_string, individual_fields, json

  // Context (optional - for debugging)
  clinicId  Int?
  patientId Int?

  // Validation Results
  wasStandardized  Boolean @default(false)
  confidence       Int? // 0-100 confidence score
  processingTimeMs Int? // Time taken to process

  // Error Tracking
  errorMessage String?

  // Truncated input preview (NOT full PHI)
  inputPreview String?

  // Audit
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([clinicId])
  @@index([source])
  @@index([createdAt])
}
