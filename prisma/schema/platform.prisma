// ==========================================================================
// PLATFORM DOMAIN
// ==========================================================================
// Bounded context: platform
// Part of multi-file Prisma schema (prisma/schema/)
// ==========================================================================

enum PlatformFeeType {
  PRESCRIPTION  // EONPRO provider writes prescription (medical fee)
  TRANSMISSION  // Clinic provider uses platform to transmit to Lifefile
  ADMIN         // Weekly admin/platform usage fee
}

enum PlatformFeeStatus {
  PENDING   // Not yet invoiced
  INVOICED  // Added to invoice
  PAID      // Invoice paid
  WAIVED    // Fee waived by admin
  VOIDED    // Order cancelled, fee voided
}

enum PlatformFeeCalculationType {
  FLAT        // Flat fee in cents (e.g., 2000 = $20.00)
  PERCENTAGE  // Percentage in basis points (e.g., 1000 = 10%)
}

enum PlatformAdminFeeType {
  NONE              // No admin fee
  FLAT_WEEKLY       // Flat fee per week in cents
  PERCENTAGE_WEEKLY // Percentage of weekly sales in basis points
}

enum ClinicInvoicePeriodType {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum ClinicInvoiceStatus {
  DRAFT      // Being prepared, not yet finalized
  PENDING    // Finalized, awaiting payment
  SENT       // Invoice sent to clinic
  PAID       // Payment received
  OVERDUE    // Past due date, unpaid
  CANCELLED  // Invoice cancelled/voided
}

// Per-clinic fee configuration - set by super admin
model ClinicPlatformFeeConfig {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicId Int    @unique
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Medical prescription fee (when EONPRO provider writes Rx)
  prescriptionFeeType   PlatformFeeCalculationType @default(FLAT)
  prescriptionFeeAmount Int                        @default(2000) // cents or basis points (2000 = $20 or 20%)

  // Transmission fee (when clinic provider uses platform to send to Lifefile)
  transmissionFeeType   PlatformFeeCalculationType @default(FLAT)
  transmissionFeeAmount Int                        @default(500) // cents or basis points (500 = $5 or 5%)

  // Admin fee (weekly platform usage)
  adminFeeType   PlatformAdminFeeType @default(NONE)
  adminFeeAmount Int                  @default(0) // cents or basis points

  // Prescription cycle tracking - days before same patient+medication is re-billable
  // Example: 90 days means if patient gets Rx on Jan 1, next billable date is April 1
  prescriptionCycleDays Int @default(90)

  // Billing contact (defaults to clinic's adminEmail if not set)
  billingEmail   String?
  billingName    String?
  billingAddress Json? // {address1, address2, city, state, zip, country}

  // Payment terms
  paymentTermsDays Int @default(30) // Net 30

  // Status
  isActive Boolean @default(true) // Enable/disable billing for this clinic

  // Audit
  createdBy Int?
  updatedBy Int?
  notes     String? // Admin notes about this configuration

  // Custom fee rules: optional array of { priority, conditions[], action, charge? } for complicated per-clinic logic.
  // When present, rules are evaluated in priority order; first match determines WAIVE or CHARGE (with optional min/max/cap).
  // Fallback: if no rule matches, standard prescriptionFee/transmissionFee config is used.
  customFeeRules Json? // @see CustomFeeRule[] in services/billing/platformFeeService

  // Relations
  feeEvents PlatformFeeEvent[]
  invoices  ClinicPlatformInvoice[]

  @@index([isActive])
}

// Individual billable event (prescription fee, transmission fee, or admin fee)
model PlatformFeeEvent {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Clinic association
  clinicId Int
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Fee configuration used (snapshot for audit)
  configId Int
  config   ClinicPlatformFeeConfig @relation(fields: [configId], references: [id])

  // Fee type
  feeType PlatformFeeType

  // Related entities (nullable based on fee type)
  // For PRESCRIPTION/TRANSMISSION fees:
  orderId    Int?     @unique // One fee per order
  order      Order?   @relation(fields: [orderId], references: [id])
  providerId Int?
  provider   Provider? @relation(fields: [providerId], references: [id])
  patientId  Int?
  patient    Patient? @relation(fields: [patientId], references: [id])

  // For ADMIN fees - the week period
  periodStart DateTime?
  periodEnd   DateTime?
  periodSales Int? // Total sales in cents for percentage calculation

  // Fee calculation
  amountCents        Int // Fee amount in cents
  calculationDetails Json? // { feeType, calculationType, rate, baseAmount, orderTotal, etc. }

  // Invoice reference (set when added to invoice)
  invoiceId Int?
  invoice   ClinicPlatformInvoice? @relation(fields: [invoiceId], references: [id])

  // Status
  status PlatformFeeStatus @default(PENDING)

  // Voiding
  voidedAt     DateTime?
  voidedBy     Int?
  voidedReason String?

  // Waiving
  waivedAt     DateTime?
  waivedBy     Int?
  waivedReason String?

  @@index([clinicId])
  @@index([createdAt])
  @@index([status])
  @@index([feeType])
  @@index([invoiceId])
}

// Aggregate fees into invoices for clinics
model ClinicPlatformInvoice {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicId Int
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Fee configuration snapshot
  configId Int
  config   ClinicPlatformFeeConfig @relation(fields: [configId], references: [id])

  // Invoice period
  periodStart DateTime
  periodEnd   DateTime
  periodType  ClinicInvoicePeriodType

  // Fee totals in cents
  prescriptionFeeTotal Int @default(0)
  transmissionFeeTotal Int @default(0)
  adminFeeTotal        Int @default(0)
  totalAmountCents     Int @default(0)

  // Fee counts
  prescriptionCount Int @default(0)
  transmissionCount Int @default(0)

  // Invoice details
  invoiceNumber String   @unique
  dueDate       DateTime

  // Stripe integration
  stripeInvoiceId  String? @unique // Stripe Invoice ID (in_xxx)
  stripeInvoiceUrl String? // Hosted invoice URL
  stripePdfUrl     String? // PDF download URL

  // PDF report (generated for detailed breakdown)
  pdfUrl     String?
  pdfS3Key   String?
  pdfS3ETag  String?

  // Status
  status ClinicInvoiceStatus @default(DRAFT)

  // Payment tracking
  paidAt          DateTime?
  paidAmountCents Int?
  paymentMethod   String? // stripe, check, wire, etc.
  paymentRef      String? // Payment reference (check #, wire ref, etc.)

  // Audit
  generatedBy Int?
  finalizedAt DateTime?
  finalizedBy Int?
  sentAt      DateTime?
  sentBy      Int?

  // Notes
  notes         String? // Internal notes
  externalNotes String? // Notes visible to clinic

  // Relations
  feeEvents PlatformFeeEvent[]

  @@index([clinicId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([dueDate])
}
