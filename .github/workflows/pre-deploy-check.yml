name: Pre-Deployment Database Check

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main, production]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  database-integrity-check:
    name: Database & Schema Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run Pre-Deployment Checks
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: npm run pre-deploy
        continue-on-error: false

      - name: Notify on Failure
        if: failure()
        run: |
          echo "⛔ PRE-DEPLOYMENT CHECK FAILED"
          echo "Database schema validation or data integrity check failed."
          echo "DO NOT DEPLOY until issues are resolved."
          exit 1

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: database-integrity-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Type Check
        run: npm run type-check
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Build
        run: npm run build

  notify-success:
    name: Pre-Deploy Success
    runs-on: ubuntu-latest
    needs: [database-integrity-check, build-check]
    if: success()
    
    steps:
      - name: Success Message
        run: |
          echo "✅ ALL PRE-DEPLOYMENT CHECKS PASSED"
          echo "Database schema: ✓"
          echo "Data integrity: ✓"
          echo "Build: ✓"
          echo "Safe to deploy to production."
